<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Formulário – Progressão Funcional (Professores PE)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h2 {
      background: #f2f2f2;
      padding: 10px;
      border-left: 4px solid #4CAF50;
    }
    .form-section {
      margin-bottom: 20px;
    }
    .form-section label {
      font-weight: bold;
    }
    .form-group {
      margin-bottom: 10px;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      margin-top: 5px;
    }
    .small-input {
      width: 100%;
      max-width: 150px;
      display: inline-block;
    }
    .medium-input {
      width: 100%;
      max-width: 300px;
      display: inline-block;
    }
    .form-inline > * {
      display: inline-block;
      vertical-align: middle;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    .output-field {
      background: #e9e9e9;
      font-weight: bold;
    }
    .terms-label {
      font-weight: normal;
    }
    button {
      background: #4CAF50;
      color: white;
      padding: 10px 20px;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background: #45a049;
    }
  </style>
</head>
<body>

  <h2>Dados Pessoais</h2>
  <form id="progressaoForm" action="https://script.google.com/macros/s/AKfycbwybDDENaIIZy5GrPE_bK5tGFxCkEjzZek8ADDcSslEb0E93YZ5ANpH_rwfa9zj27m9/exec" method="POST">
    <!-- Seção Dados Pessoais -->
    <div class="form-section">
      <div class="form-group">
        <label for="nome">Nome completo:</label>
        <input type="text" id="nome" name="nome" required placeholder="Seu nome completo" />
      </div>
      <div class="form-group">
        <label for="cpf">CPF:</label>
        <input type="text" id="cpf" name="cpf" required placeholder="___.___.___-__" 
               pattern="\d{3}\.?\d{3}\.?\d{3}-?\d{2}" title="Informe um CPF válido (11 dígitos)" />
      </div>
      <div class="form-group">
        <label>Endereço:</label>
        <!-- CEP field first, auto-fill via ViaCEP -->
        <div class="form-group">
          <input type="text" id="cep" name="endereco_cep" required placeholder="CEP" 
                 pattern="\d{5}-?\d{3}" title="Formato: 00000-000" onblur="buscarCEP()" class="medium-input" />
        </div>
        <div class="form-group form-inline">
          <input type="text" id="rua" name="endereco_rua" required placeholder="Rua/Avenida" style="width: 60%;" />
          <input type="text" id="numero" name="endereco_numero" required placeholder="Número" class="small-input" />
        </div>
        <div class="form-group form-inline">
          <input type="text" id="bairro" name="endereco_bairro" required placeholder="Bairro" class="medium-input" />
          <input type="text" id="cidade" name="endereco_cidade" required placeholder="Cidade" class="medium-input" />
          <input type="text" id="uf" name="endereco_estado" required placeholder="Estado" class="small-input" value="PE" />
        </div>
      </div>
      <div class="form-group">
        <label for="telefone">Telefone:</label>
        <input type="tel" id="telefone" name="telefone" required placeholder="(DD) ____-____" />
      </div>
      <div class="form-group">
        <label for="email">E-mail:</label>
        <input type="email" id="email" name="email" required placeholder="seuemail@exemplo.com" />
      </div>
    </div>

    <h2>Dados Funcionais</h2>
    <div class="form-section">
      <div class="form-group">
        <label for="cargo">Cargo ocupado:</label>
        <input type="text" id="cargo" name="cargo" required placeholder="Ex: Professor(a) - Matemática" />
      </div>
      <div class="form-group">
        <label for="carga_horaria">Carga horária:</label>
        <select id="carga_horaria" name="carga_horaria" required>
          <option value="" disabled selected>Selecione...</option>
          <option value="150">150h</option>
          <option value="200">200h</option>
          <option value="300">300h</option>
        </select>
      </div>
      <div class="form-group">
        <label for="data_ingresso">Data de ingresso no cargo:</label>
        <input type="date" id="data_ingresso" name="data_ingresso" required />
      </div>
      <div class="form-group">
        <label for="titulacao">Titulação:</label>
        <select id="titulacao" name="titulacao" required>
          <option value="" disabled selected>Selecione...</option>
          <option value="magisterio">Magistério (nível médio)</option>
          <option value="licenciatura">Licenciatura Plena</option>
          <option value="especializacao">Especialização</option>
          <option value="mestrado">Mestrado</option>
          <option value="doutorado">Doutorado</option>
        </select>
      </div>
      <div class="form-group">
        <label for="lotacao">Escola/Unidade de lotação:</label>
        <input type="text" id="lotacao" name="lotacao" required placeholder="Nome da Escola ou Unidade" />
      </div>
      <div class="form-group">
        <label for="matricula">Número de matrícula:</label>
        <input type="text" id="matricula" name="matricula" required placeholder="Matrícula do servidor" />
      </div>
    </div>

    <h2>Cálculo de Progressão e Diferenças</h2>
    <div class="form-section">
      <p><em>Preencha os campos acima de Data de Ingresso, Carga Horária e Titulação para visualizar o cálculo da progressão funcional e diferenças salariais.</em></p>
      <div class="form-group">
        <label for="salario_atual">Salário atual (base) do servidor:</label>
        <input type="text" id="salario_atual" name="salario_atual" placeholder="R$ 0,00 (opcional)" />
      </div>
      <!-- Campos calculados automaticamente (somente leitura) -->
      <div class="form-group">
        <label for="posicao">Posicionamento correto na carreira (Classe/Faixa):</label>
        <input type="text" id="posicao" name="posicao" class="output-field" readonly />
      </div>
      <div class="form-group">
        <label for="salario_correto">Salário base correto atual (conforme matriz):</label>
        <input type="text" id="salario_correto" name="salario_correto" class="output-field" readonly />
      </div>
      <div class="form-group">
        <label for="diferenca_mensal">Diferença mensal média:</label>
        <input type="text" id="diferenca_mensal" name="diferenca_mensal" class="output-field" readonly />
      </div>
      <div class="form-group">
        <label for="total_atrasados">Total estimado de atrasados (60 meses):</label>
        <input type="text" id="total_atrasados" name="total_atrasados" class="output-field" readonly />
      </div>
    </div>

    <h2>Termos</h2>
    <div class="form-section">
      <div class="form-group">
        <label class="terms-label">
          <input type="checkbox" id="aceite" name="aceite" required />
          Declaro que as informações fornecidas são verdadeiras e aceito os termos de uso, autorizando o contato para fins desta ação.
        </label>
      </div>
    </div>

    <button type="submit">Enviar</button>
  </form>

  <script>
    // Funções para busca de CEP via API ViaCEP
    function limpa_formulário_cep() {
      // Limpa valores dos campos de endereço.
      document.getElementById('rua').value = "";
      document.getElementById('bairro').value = "";
      document.getElementById('cidade').value = "";
      document.getElementById('uf').value = "";
    }
    function meu_callback(conteudo) {
      if (!("erro" in conteudo)) {
        // CEP encontrado: atualiza os campos.
        document.getElementById('rua').value = conteudo.logradouro;
        document.getElementById('bairro').value = conteudo.bairro;
        document.getElementById('cidade').value = conteudo.localidade;
        document.getElementById('uf').value = conteudo.uf;
      } else {
        // CEP não encontrado.
        limpa_formulário_cep();
        alert("CEP não encontrado.");
      }
    }
    function buscarCEP() {
      // Obtém o valor do CEP, filtrando dígitos.
      var cep = document.getElementById('cep').value.replace(/\D/g, '');
      if (cep != "") {
        // Expressão regular para validar o CEP (formato 8 dígitos).
        var validacep = /^[0-9]{8}$/;
        if (validacep.test(cep)) {
          // Preenche campos com "..." enquanto consulta o webservice.
          document.getElementById('rua').value = "...";
          document.getElementById('bairro').value = "...";
          document.getElementById('cidade').value = "...";
          document.getElementById('uf').value = "...";
          // Cria um elemento script para buscar o JSON do ViaCEP.
          var script = document.createElement('script');
          script.src = 'https://viacep.com.br/ws/' + cep + '/json/?callback=meu_callback';
          document.body.appendChild(script);
        } else {
          // CEP inválido.
          limpa_formulário_cep();
          alert("Formato de CEP inválido.");
        }
      } else {
        // CEP vazio, limpa formulário.
        limpa_formulário_cep();
      }
    }

    (function(){
      // Tabelas de vencimento base (atualizadas pela LC 539/2024, valores de Jan/2024)
      // Estrutura: salarios[horas][titulacao][classeIndex][faixaIndex] = valor base em R$
      // classeIndex: 0->Classe I, 1->Classe II, 2->Classe III, 3->Classe IV
      // faixaIndex: 0->A, 1->B, 2->C, 3->D
      const salarios150 = {
        "licenciatura": [
          [3435.43, 3435.43, 3435.43, 3435.43],       // Classe I (Licenciatura)
          [3435.43, 3435.43, 3435.43, 3435.43],       // Classe II (Licenciatura)
          [3532.33, 3602.98, 3675.04, 3748.54],       // Classe III (Licenciatura)
          [4123.40, 4205.86, 4289.98, 4375.78]        // Classe IV (Licenciatura)
        ],
        "especializacao": [
          [3435.43, 3435.43, 3435.43, 3435.43],       // Classe I (Especialização)
          [3435.43, 3487.77, 3557.52, 3628.67],       // Classe II (Especialização)
          [3991.54, 4071.37, 4152.80, 4235.85],       // Classe III (Especialização)
          [4659.44, 4752.63, 4847.68, 4944.63]        // Classe IV (Especialização)
        ],
        "mestrado": [
          [3435.43, 3435.43, 3474.23, 3543.72],       // Classe I (Mestrado)
          [3898.09, 3976.05, 4055.57, 4136.69],       // Classe II (Mestrado)
          [4550.35, 4641.36, 4734.19, 4828.87],       // Classe III (Mestrado)
          [5311.76, 5417.99, 5526.35, 5636.88]        // Classe IV (Mestrado)
        ],
        "doutorado": [
          [3840.22, 3917.03, 3995.37, 4075.28],       // Classe I (Doutorado)
          [4482.80, 4572.46, 4663.91, 4757.19],       // Classe II (Doutorado)
          [5232.91, 5337.56, 5444.32, 5553.20],       // Classe III (Doutorado)
          [6108.52, 6230.69, 6355.31, 6482.41]        // Classe IV (Doutorado)
        ],
        "magisterio": [
          // Obs: Para magistério (quadros em extinção), não há progressão nas tabelas atuais.
          // Considera salário base = piso do magistério (Classe I A) constante ao longo da carreira.
          [3435.43, 3435.43, 3435.43, 3435.43],       // Classe I (Magistério)
          [3435.43, 3435.43, 3435.43, 3435.43],       // Classe II
          [3435.43, 3435.43, 3435.43, 3435.43],       // Classe III
          [3435.43, 3435.43, 3435.43, 3435.43]        // Classe IV
        ]
      };
      // Para 200h e 300h, escalonamos proporcionalmente (200h = 4/3 de 150h; 300h = 2x 150h).
      function escalaSalarios(baseSalarios, fator) {
        const result = {};
        for (let tit in baseSalarios) {
          result[tit] = baseSalarios[tit].map(classe =>
            classe.map(valor => parseFloat((valor * fator).toFixed(2)))
          );
        }
        return result;
      }
      const salarios200 = escalaSalarios(salarios150, 4/3);
      const salarios300 = escalaSalarios(salarios150, 2);

      // Formata número como moeda brasileira (R$)
      function formatarReal(valor) {
        if (isNaN(valor) || valor === null) return "";
        return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      }

      // Obtém salário base correto dada horas, titulação, classe e faixa
      function obterSalarioBase(horas, titulacao, classeIndex, faixaIndex) {
        let tabela;
        if (horas === 150) tabela = salarios150;
        else if (horas === 200) tabela = salarios200;
        else if (horas === 300) tabela = salarios300;
        else return null;
        // Titulação: chave correspondente
        let titKey;
        switch(titulacao) {
          case "magisterio": titKey = "magisterio"; break;
          case "licenciatura": titKey = "licenciatura"; break;
          case "especializacao": titKey = "especializacao"; break;
          case "mestrado": titKey = "mestrado"; break;
          case "doutorado": titKey = "doutorado"; break;
          default: titKey = "licenciatura";
        }
        return tabela[titKey][classeIndex][faixaIndex];
      }

      // Determina classe e faixa de acordo com anos de serviço
      function calcularClasseFaixa(anos) {
        if (anos < 0) anos = 0;
        let classeIndex = Math.floor(anos / 4);
        let faixaIndex = anos % 4;
        if (classeIndex > 3) {
          // Limita à última classe (IV) se extrapolar tempo
          classeIndex = 3;
          faixaIndex = 3;
        } else if (classeIndex === 3) {
          // Se está na Classe IV, mas anos%4 == 0, então acabou de entrar na IV (faixa A)
          if (faixaIndex === 0 && anos >= 12) {
            faixaIndex = 0;
          }
        }
        return { classeIndex, faixaIndex };
      }

      // Elementos do form usados no cálculo
      const dataIngressoEl   = document.getElementById('data_ingresso');
      const cargaHorariaEl   = document.getElementById('carga_horaria');
      const titulacaoEl      = document.getElementById('titulacao');
      const salarioAtualEl   = document.getElementById('salario_atual');
      const posicaoEl        = document.getElementById('posicao');
      const salarioCorretoEl = document.getElementById('salario_correto');
      const diferencaMensalEl= document.getElementById('diferenca_mensal');
      const totalAtrasadosEl = document.getElementById('total_atrasados');

      // Função principal de cálculo de progressão
      function atualizarCalculos() {
        const dtValor   = dataIngressoEl.value;
        const cargaValor= parseInt(cargaHorariaEl.value);
        const titValor  = titulacaoEl.value;
        if (!dtValor || !cargaValor || !titValor) {
          // Se faltar algum dado essencial, limpa os campos calculados
          posicaoEl.value = "";
          salarioCorretoEl.value = "";
          diferencaMensalEl.value = "";
          totalAtrasadosEl.value = "";
          return;
        }
        // Calcula anos completos de serviço (considerando data exata)
        const hoje = new Date();
        const ingresso = new Date(dtValor);
        if (isNaN(ingresso.getTime())) {
          return;
        }
        let anos = hoje.getFullYear() - ingresso.getFullYear();
        const mesAtual = hoje.getMonth();
        const mesIngresso = ingresso.getMonth();
        if (mesAtual < mesIngresso || (mesAtual === mesIngresso && hoje.getDate() < ingresso.getDate())) {
          anos--; // não completou aniversário de ingresso no ano corrente
        }
        if (anos < 0) anos = 0;
        // Determina classe/faixa de direito com base nos anos
        const { classeIndex, faixaIndex } = calcularClasseFaixa(anos);
        const classes = ["I", "II", "III", "IV"];
        const faixas  = ["A", "B", "C", "D"];
        const classeDireito = classes[classeIndex];
        const faixaDireito  = faixas[faixaIndex];
        posicaoEl.value = `Classe ${classeDireito}, Faixa ${faixaDireito}`;

        // Salário base correto para essa classe/faixa
        const salarioBaseCorreto = obterSalarioBase(cargaValor, titValor, classeIndex, faixaIndex);
        salarioCorretoEl.value = salarioBaseCorreto ? formatarReal(salarioBaseCorreto) : "";

        // Se o salário atual foi fornecido, calcula as diferenças
        let diferencaMensal = null;
        let totalAtrasados = null;
        const salarioAtualStr = salarioAtualEl.value.trim();
        if (salarioAtualStr) {
          // Converte string do salário atual para número (ignora "R$", pontos e vírgulas)
          let salarioAtualNum = parseFloat(
            salarioAtualStr.replace("R$", "").replace(/\./g, "").replace(",", ".")
          );
          if (isNaN(salarioAtualNum)) {
            salarioAtualNum = null;
          }
          if (salarioBaseCorreto && salarioAtualNum != null) {
            const diffAtual = salarioBaseCorreto - salarioAtualNum;
            // Diferença mensal média:
            // Se >=5 anos de serviço, considera diferença também 5 anos atrás:
            let diffMedia = diffAtual;
            if (anos >= 5) {
              // Situação há 5 anos:
              const anos5 = anos - 5;
              const pos5 = calcularClasseFaixa(anos5);
              const salCorreto5 = obterSalarioBase(cargaValor, titValor, pos5.classeIndex, pos5.faixaIndex);
              // Supondo que sem progressão, salário há 5 anos seria o da categoria base inicial
              const salBaseAtualCategoria = obterSalarioBase(cargaValor, titValor, 0, 0); // Classe I A atual
              const diff5anos = salCorreto5 - (salBaseAtualCategoria || 0);
              diffMedia = (diffAtual + diff5anos) / 2;
            } else {
              // <5 anos de casa: assume diferença crescendo linearmente desde ingresso
              diffMedia = diffAtual / 2;
            }
            diferencaMensal = diffMedia;
            // Total de atrasados nos últimos 60 meses (ou período de serviço, se <5 anos)
            let meses = 60;
            if (anos < 5) {
              // Calcula número exato de meses desde o ingresso
              const totalMeses = (hoje.getFullYear() - ingresso.getFullYear()) * 12 + (mesAtual - mesIngresso);
              // Ajusta se o dia do mês atual ainda não alcançou o dia do ingresso
              const diaAtual = hoje.getDate();
              const diaIngresso = ingresso.getDate();
              const totalMesesAjustado = (diaAtual >= diaIngresso) ? totalMeses + 1 : totalMeses;
              meses = totalMesesAjustado;
            }
            totalAtrasados = diferencaMensal * meses;
          }
        }
        diferencaMensalEl.value = diferencaMensal != null ? formatarReal(diferencaMensal) : "";
        totalAtrasadosEl.value = totalAtrasados != null ? formatarReal(totalAtrasados) : "";
      }

      // Dispara o cálculo automático ao alterar os campos relevantes
      dataIngressoEl.addEventListener('change', atualizarCalculos);
      cargaHorariaEl.addEventListener('change', atualizarCalculos);
      titulacaoEl.addEventListener('change', atualizarCalculos);
      salarioAtualEl.addEventListener('input', atualizarCalculos);
      // Calcula ao carregar a página, caso os campos já estejam preenchidos (ex.: edição)
      document.addEventListener('DOMContentLoaded', atualizarCalculos);
    })();
  </script>

</body>
</html>
